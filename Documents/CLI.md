# PT.PM CLI

**PT.PM** можно использовать в консольном режиме (Command Line Interface). В этом случае параметры могут бысть следующими:

## -f, -files

Путь к файлу с исходником или к папке с исходниками. PT.PM сам определяет, является ли путь папкой или файлом. Один из параметров **-f** или **--patterns** должен быть указан.

## -l, --languages

Языки, которые будут обрабатываться. Поддерживаются **CSharp**, **Java**, **Php**, **PlSql**, **TSql**, **Aspx**, **JavaScript** (регистр не учитывается). Разделителем является пробел. Если параметр не задан, то язык определяется автоматически в зависимости от расширения. Если же расширение не задано или возникает неоднозначность, например расширению .sql соответствуют T-SQL и PL/SQL, то используется алгоритм определения языка по содержимому (файл парсится и выбирается тот язык, у которого меньше всего ошибок парсинга). Если язык для файла по какой-то причине не может определиться, то файл игнорируется. При этом, например, если указан язык JavaScript, то вставки JavaScript кода будут также обрабатываться внутри PHP кода.

## -m, --memory

Приблизительное потребление памяти в мегабайтах при работе парсеров ANTLR в мегабайтах. По-умолчанию **500**. ANTLR в результате работы кэширует информацию о парсинге, поэтому потребление памяти может увеличиваться вплоть до нескольких гигабайт. Поэтому время от времени необходимо очищать кэш.

## -p, --patterns

Если значение параметра оканчивается на **.json**, то шаблоны загружаются из переданного файла, в противном случае они загружаются из строки. Файл и строка имеют одинаковый формат шаблонов за исключением того, что для получения строки используется сжатие и конвертация.

Каждый шаблон представлен следующим образом:
  * **Key** - Идентификатор шаблона (string или long).
  * ***Name*** - [Опционально] Имя шаблона.
  * ***Languages*** - [Опционально] Целевые языки шаблона (**CSharp**, **Java**, **PHP**, **PLSQL**, **TSQL**, **JavaScript** или их комбинации, например, "**CSharp, Java**"). По-умолчанию: все поддерживаемые.
  * ***DataFormat*** - [Опционально] Формат описания шаблона (**JSON**, **DSL**). По-умолчанию **DSL**.
  * **Value** - Значение шаблона в формате DataFormat.
  * ***CweId*** - [Опционально] Common Weakness Enumeration Id.
  * ***Description*** - [Опционально] Описание шаблона.

Пример шаблона **Hardcoded Password Pattern**:
```JSON
{
  "Key": "96",
  "Languages": "CSharp, Java, PHP, PLSQL, TSQL",
  "DataFormat": "Dsl",
  "Value": "<[(?i)password]> = <[ \"\\w*\" || null ]>" 
}
```
  
Стоит отметить, что JSON символы "обратный слеш" (**\\**) и "кавычка" (**"**) необходимо экранировать с помощью обратного слеша **\\**. На самом деле Value выглядит попроще: `<[(?i)password(?-i)]> = <[ "\w*" || null ]>`.
  
Сжатие осуществляется с помощью стандартного .NET класса `GZipStream`. При преобразовании в base64 исходная строка конвертируется в массив байт с помощью `Encoding.UTF8`, после чего получившийся массив сжимается. В результирующий массив в первые четыре байта записывается длина несжатого массива, а затем сам сжатый массив (эта длина используется при распаковке).

Если шаблоны не заданы, то для сопоставления используются стандартные встроенные шаблоны.
  
Если задан параметр **--patterns** и не задан **-f**, то активируется режим проверки шаблонов.
  
## -t, --threads

Максимальное количество используемых потоков. **0** - на усмотрение ОС. По-умолчанию: **1**. 

* **-s**, **--stage** - Фаза, на которой процесс обработки останавливается. По-умолчанию: **match**.
  * **read** - Чтение файла
  * **parse** - Парсинг
  * **convert** - Конвертация в универсальное AST.
  * **preprocess** - Препроцессинг дерева (расчет арифметических выражений, соединение строк, упрощение шаблонов).
  * **match** - Сопоставление с шаблонами.
  * **patterns** - Режим проверки парсинга шаблонов.

## --max-stack-size

Максимальный размер стэка для потока в байтах. Используется в том случае, если в процессе парсинга ANTLR возникло исключение StackOverflow. При этом, для одного и того же файла можно сначала запустить парсинг без этого параметра, а если исключение возникло и процесс экстренно прервался, то можно использовать этот параметр (например, указать размер `int.MaxValue / 8`).

## --logs-dir

Путь к директории, в которую будут записываться логи info, errors и matching_result в процессе работы ядра. По-умолчанию запись производится в папку с исполняемым файлом.

## --log-errors

Логгировать ли ошибки. По-умолчанию: **false**.

## -v, --version

Выводить ли версию движка. По-умолчанию: **true**.